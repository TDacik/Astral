# Workflow for running tests
#
# Author: Tomas Dacik (xdacik00@fit.vutbr.cz), 2022

name: tests

on: [push, pull_request]

jobs:

  build:
    runs-on: ubuntu-latest

    container:
      image: ubuntu:latest
      options: --user root

    steps:
      - name: Checkout repository
        uses: actions/checkout@v2

      - name: Install dependencies
        run: |
          apt update
          apt install -y python3 libgmp3-dev wget patch unzip bubblewrap git gcc make bzip2 rsync

      - name: Setup OCaml
        uses: ocaml/setup-ocaml@v2
        with:
          ocaml-compiler: 4.12

      - name: Install dependencies
        run: opam install . --deps-only

      - name: Add opam binaries to path
        run: |
          echo "/home/opam/.opam/4.12/bin" >> $GITHUB_PATH
          echo $GITHUB_PATH

      - name: Test
        run: |
          opam list
          echo $PATH
          echo $GITHUB_PATH
          which dune

      - name: Install Astral
        run: |
          dune build
          dune install

      - name: Run tests
        run: python3 scripts/run_tests.py
